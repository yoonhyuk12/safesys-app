import { NextRequest, NextResponse } from 'next/server';

// 기상청 지역 코드 매핑 데이터 (주요 지역)
const REGION_CODE_MAP: { [key: string]: string } = {
  // 서울특별시
  '서울': '1100000000',
  '서울특별시': '1100000000',
  '종로구': '1111000000',
  '중구': '1114000000',
  '용산구': '1117000000',
  '성동구': '1120000000',
  '광진구': '1121500000',
  '동대문구': '1123000000',
  '중랑구': '1126000000',
  '성북구': '1129000000',
  '강북구': '1130500000',
  '도봉구': '1132000000',
  '노원구': '1135000000',
  '은평구': '1138000000',
  '서대문구': '1141000000',
  '마포구': '1144000000',
  '양천구': '1147000000',
  '강서구': '1150000000',
  '구로구': '1153000000',
  '금천구': '1154500000',
  '영등포구': '1156000000',
  '동작구': '1159000000',
  '관악구': '1162000000',
  '서초구': '1165000000',
  '강남구': '1168000000',
  '송파구': '1171000000',
  '강동구': '1174000000',
  
  // 경기도
  '경기': '4100000000',
  '경기도': '4100000000',
  '수원시': '4111000000',
  '성남시': '4113000000',
  '의정부시': '4115000000',
  '안양시': '4117000000',
  '부천시': '4119000000',
  '광명시': '4121000000',
  '평택시': '4122000000',
  '동두천시': '4125000000',
  '안산시': '4127000000',
  '고양시': '4128000000',
  '과천시': '4129000000',
  '구리시': '4131000000',
  '남양주시': '4136000000',
  '오산시': '4137000000',
  '시흥시': '4139000000',
  '군포시': '4141000000',
  '의왕시': '4143000000',
  '하남시': '4145000000',
  '용인시': '4146000000',
  '파주시': '4148000000',
  '이천시': '4150000000',
  '안성시': '4155000000',
  '김포시': '4157000000',
  '화성시': '4159000000',
  '광주시': '4161000000',
  '양주시': '4163000000',
  '포천시': '4165000000',
  '여주시': '4167000000',
  '연천군': '4180000000',
  '가평군': '4182000000',
  '양평군': '4183000000',
  
  // 인천광역시
  '인천': '2300000000',
  '인천광역시': '2300000000',
  '인천 중구': '2310000000',
  '인천 동구': '2320000000',
  '미추홀구': '2325000000',
  '연수구': '2330000000',
  '남동구': '2335000000',
  '부평구': '2340000000',
  '계양구': '2345000000',
  '인천 서구': '2350000000',
  '강화군': '2370000000',
  '옹진군': '2371000000',
  
  // 부산광역시
  '부산': '2600000000',
  '부산광역시': '2600000000',
  '부산 중구': '2611000000',
  '부산 서구': '2614000000',
  '부산 동구': '2617000000',
  '영도구': '2620000000',
  '부산진구': '2623000000',
  '동래구': '2626000000',
  '부산 남구': '2629000000',
  '부산 북구': '2632000000',
  '해운대구': '2635000000',
  '사하구': '2638000000',
  '금정구': '2641000000',
  '부산 강서구': '2644000000',
  '연제구': '2647000000',
  '수영구': '2650000000',
  '사상구': '2653000000',
  '기장군': '2671000000',
  
  // 대구광역시
  '대구': '2700000000',
  '대구광역시': '2700000000',
  '대구 중구': '2711000000',
  '대구 동구': '2714000000',
  '대구 서구': '2717000000',
  '대구 남구': '2720000000',
  '대구 북구': '2723000000',
  '수성구': '2726000000',
  '달서구': '2729000000',
  '달성군': '2771000000',
  
  // 광주광역시
  '광주': '2900000000',
  '광주광역시': '2900000000',
  '광주 동구': '2911000000',
  '광주 서구': '2914000000',
  '광주 남구': '2917000000',
  '광주 북구': '2920000000',
  '광산구': '2923000000',
  
  // 대전광역시
  '대전': '3000000000',
  '대전광역시': '3000000000',
  '대전 동구': '3011000000',
  '대전 중구': '3014000000',
  '대전 서구': '3017000000',
  '유성구': '3020000000',
  '대덕구': '3023000000',
  
  // 울산광역시
  '울산': '3100000000',
  '울산광역시': '3100000000',
  '울산 중구': '3111000000',
  '울산 남구': '3114000000',
  '울산 동구': '3117000000',
  '울산 북구': '3120000000',
  '울주군': '3171000000'
};

// 좌표 기반 지역 코드 추정 (대략적인 위치 매핑)
function getRegionCodeByCoords(lat: number, lng: number): string {
  // 서울 (37.4-37.7, 126.8-127.2)
  if (lat >= 37.4 && lat <= 37.7 && lng >= 126.8 && lng <= 127.2) {
    return '1100000000'; // 서울특별시
  }
  
  // 인천 (37.3-37.6, 126.4-126.8)
  if (lat >= 37.3 && lat <= 37.6 && lng >= 126.4 && lng <= 126.8) {
    return '2300000000'; // 인천광역시
  }
  
  // 경기도 (37.0-38.0, 126.5-127.8)
  if (lat >= 37.0 && lat <= 38.0 && lng >= 126.5 && lng <= 127.8) {
    return '4100000000'; // 경기도
  }
  
  // 부산 (35.0-35.4, 128.8-129.3)
  if (lat >= 35.0 && lat <= 35.4 && lng >= 128.8 && lng <= 129.3) {
    return '2600000000'; // 부산광역시
  }
  
  // 대구 (35.6-36.0, 128.4-128.8)
  if (lat >= 35.6 && lat <= 36.0 && lng >= 128.4 && lng <= 128.8) {
    return '2700000000'; // 대구광역시
  }
  
  // 광주 (35.0-35.3, 126.7-127.0)
  if (lat >= 35.0 && lat <= 35.3 && lng >= 126.7 && lng <= 127.0) {
    return '2900000000'; // 광주광역시
  }
  
  // 대전 (36.2-36.5, 127.2-127.6)
  if (lat >= 36.2 && lat <= 36.5 && lng >= 127.2 && lng <= 127.6) {
    return '3000000000'; // 대전광역시
  }
  
  // 울산 (35.4-35.7, 129.1-129.4)
  if (lat >= 35.4 && lat <= 35.7 && lng >= 129.1 && lng <= 129.4) {
    return '3100000000'; // 울산광역시
  }
  
  // 기본값: 서울
  return '1100000000';
}

// 주소에서 지역 코드 추출
function getRegionCodeByAddress(address: string): string {
  const normalizedAddress = address.replace(/\s+/g, ' ').trim();
  
  // 정확한 매칭 우선 시도
  for (const [region, code] of Object.entries(REGION_CODE_MAP)) {
    if (normalizedAddress.includes(region)) {
      return code;
    }
  }
  
  // 부분 매칭 시도
  const addressParts = normalizedAddress.split(' ');
  for (const part of addressParts) {
    for (const [region, code] of Object.entries(REGION_CODE_MAP)) {
      if (part.includes(region) || region.includes(part)) {
        return code;
      }
    }
  }
  
  // 기본값: 서울
  return '1100000000';
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { address, lat, lng } = body;

    if (!address && (!lat || !lng)) {
      return NextResponse.json(
        { error: '주소 또는 좌표 정보가 필요합니다' },
        { status: 400 }
      );
    }

    let regionCode: string;
    let method: string;

    if (address) {
      // 주소 기반 지역 코드 추출
      regionCode = getRegionCodeByAddress(address);
      method = 'address';
      console.log(`주소 기반 지역코드 매핑: ${address} -> ${regionCode}`);
    } else {
      // 좌표 기반 지역 코드 추정
      regionCode = getRegionCodeByCoords(lat, lng);
      method = 'coordinates';
      console.log(`좌표 기반 지역코드 매핑: (${lat}, ${lng}) -> ${regionCode}`);
    }

    // 기상청 날씨누리 상세보기 URL 생성
    const weatherDetailUrl = `https://www.weather.go.kr/w/theme/daily-life/regional-composite-index.do#dong/${regionCode}/${lat || 37.5665}/${lng || 126.9780}/`;

    return NextResponse.json({
      success: true,
      regionCode,
      weatherDetailUrl,
      method,
      coordinates: lat && lng ? { lat, lng } : null,
      address: address || null,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('지역코드 매핑 오류:', error);
    
    // 에러 시 기본값 반환 (서울)
    const fallbackRegionCode = '1100000000';
    const fallbackUrl = `https://www.weather.go.kr/w/theme/daily-life/regional-composite-index.do#dong/${fallbackRegionCode}/37.5665/126.9780/`;
    
    return NextResponse.json({
      success: false,
      regionCode: fallbackRegionCode,
      weatherDetailUrl: fallbackUrl,
      method: 'fallback',
      error: '지역코드 매핑 실패, 서울 기본값 사용',
      details: error instanceof Error ? error.message : String(error)
    });
  }
}